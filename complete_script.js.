document.addEventListener('DOMContentLoaded', () => {
    initHeader();
    initMobileMenu();
    initScrollTriggers();
    initCookieBanner();
    initButtons();
    initSearch();
    initAccessibility();
    new ShoppingCart();
    new NewsletterSignup();
    trackPageView();
});

/* 1. Header scroll behavior */
function initHeader() {
    const header = document.querySelector('.site-header');
    if (!header) return;

    let ticking = false;
    function updateHeader() {
        if (window.scrollY > 50) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
        ticking = false;
    }

    window.addEventListener('scroll', () => {
        if (!ticking) {
            requestAnimationFrame(updateHeader);
            ticking = true;
        }
    }, { passive: true });
}

/* 2. Mobile menu toggle */
function initMobileMenu() {
    const hamburger = document.querySelector('.hamburger');
    const mobileNav = document.querySelector('.mobile-nav');
    const overlay = document.querySelector('.mobile-menu-overlay');
    const closeBtn = document.querySelector('.close-menu');
    const mobileLinks = document.querySelectorAll('.mobile-menu a');

    if (!hamburger || !mobileNav) return;

    function toggleMenu(open = null) {
        const shouldOpen = open !== null ? open : !mobileNav.classList.contains('active');
        
        mobileNav.classList.toggle('active', shouldOpen);
        overlay?.classList.toggle('active', shouldOpen);
        document.body.style.overflow = shouldOpen ? 'hidden' : '';
        hamburger.setAttribute('aria-expanded', shouldOpen.toString());
    }

    hamburger.addEventListener('click', () => toggleMenu());
    closeBtn?.addEventListener('click', () => toggleMenu(false));
    overlay?.addEventListener('click', () => toggleMenu(false));
    mobileLinks.forEach(link => link.addEventListener('click', () => toggleMenu(false)));

    // Close on ESC key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && mobileNav.classList.contains('active')) {
            toggleMenu(false);
        }
    });
}

/* 3. Scroll animations with GSAP + ScrollTrigger */
function initScrollTriggers() {
    // Check if GSAP is available
    if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') {
        // Fallback to simple CSS animations
        const animatedElements = document.querySelectorAll('[data-animate]');
        if (!animatedElements.length) return;

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animated');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });

        animatedElements.forEach(el => observer.observe(el));
        return;
    }

    try {
        gsap.registerPlugin(ScrollTrigger);

        document.querySelectorAll('.product-card[data-animate]').forEach((card, i) => {
            gsap.from(card, {
                scrollTrigger: {
                    trigger: card,
                    start: 'top 80%',
                    toggleActions: 'play none none reverse'
                },
                duration: 0.8,
                opacity: 0,
                y: 40,
                delay: Math.min(i * 0.1, 0.5) // Cap delay to prevent too long animations
            });
        });

        const aboutGrid = document.querySelector('.about-grid');
        if (aboutGrid) {
            const aboutContent = aboutGrid.querySelector('.about-content[data-animate]');
            const aboutImage = aboutGrid.querySelector('.about-image[data-animate]');
            
            if (aboutContent) {
                gsap.from(aboutContent, {
                    scrollTrigger: { trigger: aboutGrid, start: 'top 60%' },
                    duration: 1,
                    opacity: 0,
                    x: -50
                });
            }
            
            if (aboutImage) {
                gsap.from(aboutImage, {
                    scrollTrigger: { trigger: aboutGrid, start: 'top 60%' },
                    duration: 1,
                    opacity: 0,
                    x: 50
                });
            }
        }
    } catch (error) {
        console.error('GSAP initialization failed:', error);
    }
}

/* 4. Cookie banner logic */
function initCookieBanner() {
    const banner = document.getElementById('cookieBanner');
    const floatBtn = document.getElementById('cookieFloatBtn');
    if (!banner) return;

    const acceptBtn = banner.querySelector('.cookie-accept');
    const rejectBtn = banner.querySelector('.cookie-reject');
    const settingsBtn = banner.querySelector('.cookie-settings');
    const closeBtn = banner.querySelector('.cookie-close');

    const choice = localStorage.getItem('cookieChoice');
    if (choice) {
        banner.classList.add('hidden');
        if (choice === 'accepted' && floatBtn) {
            floatBtn.classList.add('show');
        }
    } else {
        // Show banner after a short delay for new visitors
        setTimeout(() => banner.classList.add('show'), 1000);
    }

    acceptBtn?.addEventListener('click', () => {
        localStorage.setItem('cookieChoice', 'accepted');
        banner.classList.add('hidden');
        floatBtn?.classList.add('show');
        trackEvent('cookie_accepted');
    });

    rejectBtn?.addEventListener('click', () => {
        localStorage.setItem('cookieChoice', 'rejected');
        banner.classList.add('hidden');
        trackEvent('cookie_rejected');
    });

    settingsBtn?.addEventListener('click', () => {
        console.log('Open cookie settings modal');
        // TODO: Implement cookie settings modal
    });

    closeBtn?.addEventListener('click', () => {
        banner.classList.add('hidden');
    });

    floatBtn?.addEventListener('click', () => {
        banner.classList.remove('hidden');
        floatBtn.classList.remove('show');
    });
}

/* 5. Generic button tracking */
function initButtons() {
    const buttons = document.querySelectorAll('.btn, .btn-hdmz, [data-track-click]');
    buttons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const trackData = {
                text: btn.textContent?.trim() || '',
                href: btn.href || '',
                type: btn.dataset.trackType || 'button'
            };
            trackEvent('button_click', trackData);
        });
    });
}

/* 6. Simple search modal */
function initSearch() {
    const trigger = document.getElementById('search-trigger');
    if (!trigger) return;

    let modal = null;

    trigger.addEventListener('click', (e) => {
        e.preventDefault();
        if (!modal) {
            modal = createSearchModal();
            document.body.appendChild(modal);
        }
        modal.classList.add('active');
        const input = modal.querySelector('input');
        input?.focus();
        trigger.setAttribute('aria-expanded', 'true');
    });
}

function createSearchModal() {
    const modal = document.createElement('div');
    modal.className = 'search-modal';
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-label', 'Search');
    modal.innerHTML = `
        <div class="search-modal-content">
            <button class="search-modal-close" aria-label="Close search">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"></path>
                </svg>
            </button>
            <div class="search-modal-input">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="search" placeholder="Search products..." aria-label="Search products" autofocus>
            </div>
            <div class="search-modal-results" role="region" aria-live="polite"></div>
        </div>
    `;

    const close = () => {
        modal.classList.remove('active');
        document.getElementById('search-trigger')?.setAttribute('aria-expanded', 'false');
    };

    modal.querySelector('.search-modal-close')?.addEventListener('click', close);
    modal.addEventListener('click', e => { 
        if (e.target === modal) close(); 
    });
    
    document.addEventListener('keydown', e => { 
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            close();
        }
    });

    const input = modal.querySelector('input');
    const results = modal.querySelector('.search-modal-results');
    
    // Debounce search
    let searchTimeout;
    input?.addEventListener('input', e => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => performSearch(e.target.value, results), 300);
    });

    return modal;
}

function performSearch(query, resultsContainer) {
    if (!resultsContainer) return;
    
    const q = query.toLowerCase().trim();
    
    if (!q) {
        resultsContainer.innerHTML = '<p class="search-empty">Start typing to search...</p>';
        return;
    }
    
    // Get products from DOM
    const products = Array.from(document.querySelectorAll('.product-card')).map(card => {
        return {
            name: card.querySelector('h3, .product-title')?.textContent?.trim() || '',
            price: card.querySelector('.price, .product-price')?.textContent?.trim() || '',
            link: card.querySelector('a')?.href || '#'
        };
    }).filter(p => p.name); // Filter out empty products

    const filtered = products.filter(p => 
        p.name.toLowerCase().includes(q)
    );
    
    if (!filtered.length) {
        resultsContainer.innerHTML = '<p class="search-empty">No products found</p>';
        return;
    }
    
    resultsContainer.innerHTML = filtered.map(p => `
        <a href="${p.link}" class="search-result">
            <div class="search-result-name">${p.name}</div>
            <div class="search-result-price">${p.price}</div>
        </a>
    `).join('');
}

/* 7. Basic accessibility enhancements */
function initAccessibility() {
    // Skip to main content link
    const skipLink = document.querySelector('.skip-to-main');
    if (skipLink) {
        skipLink.addEventListener('click', (e) => {
            e.preventDefault();
            const main = document.querySelector('#main-content, main, [role="main"]');
            if (main) {
                main.tabIndex = -1;
                main.focus();
                main.scrollIntoView();
            }
        });
    }

    // Manage focus for modals
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
            const activeModal = document.querySelector('.modal.active, .search-modal.active');
            if (activeModal) {
                const focusableElements = activeModal.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                const firstFocusable = focusableElements[0];
                const lastFocusable = focusableElements[focusableElements.length - 1];

                if (e.shiftKey) {
                    if (document.activeElement === firstFocusable) {
                        e.preventDefault();
                        lastFocusable?.focus();
                    }
                } else {
                    if (document.activeElement === lastFocusable) {
                        e.preventDefault();
                        firstFocusable?.focus();
                    }
                }
            }
        }
    });
}

/* 8. Shopping cart class */
class ShoppingCart {
    constructor() {
        this.items = this.loadCart();
        this.setupCartButtons();
        this.updateCartCount();
    }

    setupCartButtons() {
        document.querySelectorAll('[data-product-id]').forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                const card = btn.closest('.product-card');
                if (!card) {
                    console.error('Product card not found');
                    return;
                }
                
                const id = btn.dataset.productId;
                const name = card.querySelector('h3, .product-title')?.textContent?.trim() || 'Unknown Product';
                const priceEl = card.querySelector('.price, .product-price');
                let price = 0;
                
                if (priceEl) {
                    // Handle various price formats
                    const priceText = priceEl.textContent?.replace(/[^0-9.]/g, '') || '0';
                    price = parseFloat(priceText) || 0;
                }
                
                this.addItem({ id, name, price });
            });
        });
    }

    addItem(product) {
        if (!product.id) {
            console.error('Product ID is required');
            return;
        }

        const existing = this.items.find(i => i.id === product.id);
        if (existing) {
            existing.quantity = (existing.quantity || 0) + 1;
        } else {
            this.items.push({ ...product, quantity: 1 });
        }
        
        this.saveCart();
        this.updateCartCount();
        this.showNotification(`${product.name} added to cart`);
        trackEvent('add_to_cart', product);
    }

    loadCart() {
        try {
            const raw = localStorage.getItem('wellness_cart');
            return raw ? JSON.parse(raw) : [];
        } catch (error) {
            console.error('Failed to load cart:', error);
            return [];
        }
    }

    saveCart() {
        try {
            localStorage.setItem('wellness_cart', JSON.stringify(this.items));
        } catch (error) {
            console.error('Failed to save cart:', error);
        }
    }

    updateCartCount() {
        const countEl = document.querySelector('.cart-count');
        if (!countEl) return;
        
        const count = this.items.reduce((sum, i) => sum + (i.quantity || 0), 0);
        countEl.textContent = count.toString();
        countEl.style.display = count > 0 ? 'flex' : 'none';
        countEl.setAttribute('aria-label', `Cart has ${count} item${count !== 1 ? 's' : ''}`);
    }

    showNotification(message) {
        // Remove any existing notification
        const existing = document.querySelector('.cart-notification');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'cart-notification';
        toast.textContent = message;
        toast.setAttribute('role', 'status');
        toast.setAttribute('aria-live', 'polite');
        document.body.appendChild(toast);
        
        requestAnimationFrame(() => {
            toast.classList.add('show');
        });
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 2500);
    }
}

/* 9. Newsletter signup class */
class NewsletterSignup {
    constructor() {
        this.form = document.querySelector('.newsletter-form');
        this.isSubmitting = false;
        if (this.form) this.init();
    }

    init() {
        this.form.addEventListener('submit', e => this.handleSubmit(e));
        
        // Add real-time validation
        const emailInput = this.form.querySelector('input[type="email"]');
        if (emailInput) {
            emailInput.addEventListener('blur', () => {
                if (emailInput.value && !this.isValidEmail(emailInput.value)) {
                    this.showFeedback('Please enter a valid email address.', 'error');
                }
            });
        }
    }

    async handleSubmit(e) {
        e.preventDefault();
        
        if (this.isSubmitting) return;
        
        const emailInput = this.form.querySelector('input[type="email"]');
        if (!emailInput) return;
        
        const email = emailInput.value.trim();
        
        if (!this.isValidEmail(email)) {
            this.showFeedback('Please enter a valid email address.', 'error');
            emailInput.focus();
            return;
        }
        
        this.isSubmitting = true;
        const submitBtn = this.form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Subscribing...';
        }
        
        try {
            // Simulate API call - replace with actual endpoint
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            console.log('Newsletter signup:', email);
            trackEvent('newsletter_signup', { email: email.split('@')[0] + '@...' }); // Privacy-safe tracking
            
            this.showFeedback('Thanks for subscribing! Check your email for confirmation.', 'success');
            this.form.reset();
        } catch (error) {
            console.error('Newsletter signup failed:', error);
            this.showFeedback('Something went wrong. Please try again later.', 'error');
        } finally {
            this.isSubmitting = false;
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Subscribe';
            }
        }
    }

    isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
        return emailRegex.test(email);
    }

    showFeedback(msg, type) {
        const existing = this.form.parentElement?.querySelector('.newsletter-feedback');
        if (existing) existing.remove();
        
        const p = document.createElement('p');
        p.className = `newsletter-feedback newsletter-feedback--${type}`;
        p.textContent = msg;
        p.setAttribute('role', type === 'error' ? 'alert' : 'status');
        p.setAttribute('aria-live', 'polite');
        
        this.form.parentElement?.appendChild(p);
        
        // Auto-remove success messages
        if (type === 'success') {
            setTimeout(() => p.remove(), 5000);
        }
    }
}

/* 10. Analytics helpers */
function trackEvent(name, data = {}) {
    const choice = localStorage.getItem('cookieChoice');
    if (choice !== 'accepted') return;
    
    const eventData = {
        event: name,
        timestamp: new Date().toISOString(),
        ...data
    };
    
    console.log('Track Event:', eventData);
    
    // Google Analytics integration
    if (typeof gtag !== 'undefined') {
        gtag('event', name, data);
    }
    
    // Custom analytics endpoint
    // fetch('/api/analytics', { method: 'POST', body: JSON.stringify(eventData) })
}

function trackPageView() {
    trackEvent('page_view', {
        title: document.title,
        path: window.location.pathname,
        referrer: document.referrer
    });
}
